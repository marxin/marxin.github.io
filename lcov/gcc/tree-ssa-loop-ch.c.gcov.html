<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - gcc.info - gcc/tree-ssa-loop-ch.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">gcc</a> - tree-ssa-loop-ch.c<span style="font-size: 80%;"> (source / <a href="tree-ssa-loop-ch.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">gcc.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">151</td>
            <td class="headerCovTableEntry">164</td>
            <td class="headerCovTableEntryHi">92.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-09-22 10:58:49</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* Loop header copying on trees.</a>
<span class="lineNum">       2 </span>            :    Copyright (C) 2004-2018 Free Software Foundation, Inc.
<span class="lineNum">       3 </span>            : 
<span class="lineNum">       4 </span>            : This file is part of GCC.
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : GCC is free software; you can redistribute it and/or modify it
<span class="lineNum">       7 </span>            : under the terms of the GNU General Public License as published by the
<span class="lineNum">       8 </span>            : Free Software Foundation; either version 3, or (at your option) any
<span class="lineNum">       9 </span>            : later version.
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : GCC is distributed in the hope that it will be useful, but WITHOUT
<span class="lineNum">      12 </span>            : ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
<span class="lineNum">      13 </span>            : FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
<span class="lineNum">      14 </span>            : for more details.
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : You should have received a copy of the GNU General Public License
<span class="lineNum">      17 </span>            : along with GCC; see the file COPYING3.  If not see
<span class="lineNum">      18 </span>            : &lt;http://www.gnu.org/licenses/&gt;.  */
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : #include &quot;config.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;system.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;coretypes.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;backend.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;tree.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;gimple.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;cfghooks.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;tree-pass.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;gimple-ssa.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;gimple-iterator.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;tree-cfg.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;tree-into-ssa.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;cfgloop.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;tree-inline.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;tree-ssa-scopedtables.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;tree-ssa-threadedge.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;params.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : /* Duplicates headers of loops if they are small enough, so that the statements
<span class="lineNum">      39 </span>            :    in the loop body are always executed when the loop is entered.  This
<span class="lineNum">      40 </span>            :    increases effectiveness of code motion optimizations, and reduces the need
<span class="lineNum">      41 </span>            :    for loop preconditioning.  */
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : /* Check whether we should duplicate HEADER of LOOP.  At most *LIMIT
<span class="lineNum">      44 </span>            :    instructions should be duplicated, limit is decreased by the actual
<span class="lineNum">      45 </span>            :    amount.  */
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : static bool
<span class="lineNum">      48 </span><span class="lineCov">     212013 : should_duplicate_loop_header_p (basic_block header, struct loop *loop,</span>
<span class="lineNum">      49 </span>            :                                 int *limit)
<span class="lineNum">      50 </span>            : {
<span class="lineNum">      51 </span><span class="lineCov">     212013 :   gimple_stmt_iterator bsi;</span>
<span class="lineNum">      52 </span><span class="lineCov">     212013 :   gimple *last;</span>
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineCov">     212013 :   gcc_assert (!header-&gt;aux);</span>
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            :   /* Loop header copying usually increases size of the code.  This used not to
<span class="lineNum">      57 </span>            :      be true, since quite often it is possible to verify that the condition is
<span class="lineNum">      58 </span>            :      satisfied in the first iteration and therefore to eliminate it.  Jump
<span class="lineNum">      59 </span>            :      threading handles these cases now.  */
<span class="lineNum">      60 </span><span class="lineCov">     212013 :   if (optimize_loop_for_size_p (loop)</span>
<span class="lineNum">      61 </span><span class="lineCov">     212013 :       &amp;&amp; !loop-&gt;force_vectorize)</span>
<span class="lineNum">      62 </span>            :     {
<span class="lineNum">      63 </span><span class="lineCov">      16619 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">      65 </span>            :                  &quot;  Not duplicating bb %i: optimizing for size.\n&quot;,
<span class="lineNum">      66 </span>            :                  header-&gt;index);
<span class="lineNum">      67 </span><span class="lineCov">      16619 :       return false;</span>
<span class="lineNum">      68 </span>            :     }
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineCov">     195394 :   gcc_assert (EDGE_COUNT (header-&gt;succs) &gt; 0);</span>
<span class="lineNum">      71 </span><span class="lineCov">     390788 :   if (single_succ_p (header))</span>
<span class="lineNum">      72 </span>            :     {
<span class="lineNum">      73 </span><span class="lineCov">       7810 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">      75 </span>            :                  &quot;  Not duplicating bb %i: it is single succ.\n&quot;,
<span class="lineNum">      76 </span>            :                  header-&gt;index);
<span class="lineNum">      77 </span><span class="lineCov">       7810 :       return false;</span>
<span class="lineNum">      78 </span>            :     }
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineCov">     187584 :   if (flow_bb_inside_loop_p (loop, EDGE_SUCC (header, 0)-&gt;dest)</span>
<span class="lineNum">      81 </span><span class="lineCov">     187584 :       &amp;&amp; flow_bb_inside_loop_p (loop, EDGE_SUCC (header, 1)-&gt;dest))</span>
<span class="lineNum">      82 </span>            :     {
<span class="lineNum">      83 </span><span class="lineCov">       5648 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">      85 </span>            :                  &quot;  Not duplicating bb %i: both sucessors are in loop.\n&quot;,
<span class="lineNum">      86 </span>            :                  loop-&gt;num);
<span class="lineNum">      87 </span><span class="lineCov">       5648 :       return false;</span>
<span class="lineNum">      88 </span>            :     }
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            :   /* If this is not the original loop header, we want it to have just
<span class="lineNum">      91 </span>            :      one predecessor in order to match the &amp;&amp; pattern.  */
<span class="lineNum">      92 </span><span class="lineCov">     181936 :   if (header != loop-&gt;header &amp;&amp; !single_pred_p (header))</span>
<span class="lineNum">      93 </span>            :     {
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">      96 </span>            :                  &quot;  Not duplicating bb %i: it has mutiple predecestors.\n&quot;,
<span class="lineNum">      97 </span>            :                  header-&gt;index);
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">      99 </span>            :     }
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineCov">     181936 :   last = last_stmt (header);</span>
<span class="lineNum">     102 </span><span class="lineCov">     363872 :   if (gimple_code (last) != GIMPLE_COND)</span>
<span class="lineNum">     103 </span>            :     {
<span class="lineNum">     104 </span><span class="lineCov">       7828 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">     106 </span>            :                  &quot;  Not duplicating bb %i: it does not end by conditional.\n&quot;,
<span class="lineNum">     107 </span>            :                  header-&gt;index);
<span class="lineNum">     108 </span><span class="lineCov">       7828 :       return false;</span>
<span class="lineNum">     109 </span>            :     }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            :   /* Count number of instructions and punt on calls.  */
<span class="lineNum">     112 </span><span class="lineCov">     944912 :   for (bsi = gsi_start_bb (header); !gsi_end_p (bsi); gsi_next (&amp;bsi))</span>
<span class="lineNum">     113 </span>            :     {
<span class="lineNum">     114 </span><span class="lineCov">     604467 :       last = gsi_stmt (bsi);</span>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineCov">    1208934 :       if (gimple_code (last) == GIMPLE_LABEL)</span>
<span class="lineNum">     117 </span>            :         continue;
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineCov">    1206962 :       if (is_gimple_debug (last))</span>
<span class="lineNum">     120 </span>            :         continue;
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineCov">     296212 :       if (gimple_code (last) == GIMPLE_CALL</span>
<span class="lineNum">     123 </span><span class="lineCov">     296212 :           &amp;&amp; (!gimple_inexpensive_call_p (as_a &lt;gcall *&gt; (last))</span>
<span class="lineNum">     124 </span>            :               /* IFN_LOOP_DIST_ALIAS means that inner loop is distributed
<span class="lineNum">     125 </span>            :                  at current loop's header.  Don't copy in this case.  */
<span class="lineNum">     126 </span><span class="lineCov">       3344 :               || gimple_call_internal_p (last, IFN_LOOP_DIST_ALIAS)))</span>
<span class="lineNum">     127 </span>            :         {
<span class="lineNum">     128 </span><span class="lineCov">       7648 :           if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :             fprintf (dump_file,</span>
<span class="lineNum">     130 </span>            :                      &quot;  Not duplicating bb %i: it contains call.\n&quot;,
<span class="lineNum">     131 </span>            :                      header-&gt;index);
<span class="lineNum">     132 </span><span class="lineCov">       7648 :           return false;</span>
<span class="lineNum">     133 </span>            :         }
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">     288564 :       *limit -= estimate_num_insns (last, &amp;eni_size_weights);</span>
<span class="lineNum">     136 </span><span class="lineCov">     288564 :       if (*limit &lt; 0)</span>
<span class="lineNum">     137 </span>            :         {
<span class="lineNum">     138 </span><span class="lineCov">        123 :           if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :             fprintf (dump_file,</span>
<span class="lineNum">     140 </span>            :                      &quot;  Not duplicating bb %i contains too many insns.\n&quot;,
<span class="lineNum">     141 </span>            :                      header-&gt;index);
<span class="lineNum">     142 </span><span class="lineCov">        123 :           return false;</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            :     }
<span class="lineNum">     145 </span><span class="lineCov">     166337 :   if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     146 </span><span class="lineCov">          4 :     fprintf (dump_file, &quot;    Will duplicate bb %i\n&quot;, header-&gt;index); </span>
<span class="lineNum">     147 </span>            :   return true;
<span class="lineNum">     148 </span>            : }
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span>            : /* Checks whether LOOP is a do-while style loop.  */
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            : static bool
<span class="lineNum">     153 </span><span class="lineCov">     409250 : do_while_loop_p (struct loop *loop)</span>
<span class="lineNum">     154 </span>            : {
<span class="lineNum">     155 </span><span class="lineCov">     409250 :   gimple *stmt = last_stmt (loop-&gt;latch);</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            :   /* If the latch of the loop is not empty, it is not a do-while loop.  */
<span class="lineNum">     158 </span><span class="lineCov">     409250 :   if (stmt</span>
<span class="lineNum">     159 </span><span class="lineCov">     409250 :       &amp;&amp; gimple_code (stmt) != GIMPLE_LABEL)</span>
<span class="lineNum">     160 </span>            :     {
<span class="lineNum">     161 </span><span class="lineCov">     191857 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     162 </span><span class="lineCov">          3 :         fprintf (dump_file,</span>
<span class="lineNum">     163 </span>            :                  &quot;Loop %i is not do-while loop: latch is not empty.\n&quot;,
<span class="lineNum">     164 </span>            :                  loop-&gt;num);
<span class="lineNum">     165 </span><span class="lineCov">     191857 :       return false;</span>
<span class="lineNum">     166 </span>            :     }
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :   /* If the latch does not have a single predecessor, it is not a
<span class="lineNum">     169 </span>            :      do-while loop.  */
<span class="lineNum">     170 </span><span class="lineCov">     217393 :   if (!single_pred_p (loop-&gt;latch))</span>
<span class="lineNum">     171 </span>            :     {
<span class="lineNum">     172 </span><span class="lineCov">      15387 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     173 </span><span class="lineCov">          1 :         fprintf (dump_file,</span>
<span class="lineNum">     174 </span>            :                  &quot;Loop %i is not do-while loop: latch has multiple &quot;
<span class="lineNum">     175 </span>            :                  &quot;predecessors.\n&quot;, loop-&gt;num);
<span class="lineNum">     176 </span><span class="lineCov">      15387 :       return false;</span>
<span class="lineNum">     177 </span>            :     }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span>            :   /* If the latch predecessor doesn't exit the loop, it is not a
<span class="lineNum">     180 </span>            :      do-while loop.  */
<span class="lineNum">     181 </span><span class="lineCov">     202006 :   if (!loop_exits_from_bb_p (loop, single_pred (loop-&gt;latch)))</span>
<span class="lineNum">     182 </span>            :     {
<span class="lineNum">     183 </span><span class="lineCov">       4769 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :         fprintf (dump_file,</span>
<span class="lineNum">     185 </span>            :                  &quot;Loop %i is not do-while loop: latch predecessor &quot;
<span class="lineNum">     186 </span>            :                  &quot;does not exit loop.\n&quot;, loop-&gt;num);
<span class="lineNum">     187 </span><span class="lineCov">       4769 :       return false;</span>
<span class="lineNum">     188 </span>            :     }
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span><span class="lineCov">     197237 :   if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     191 </span><span class="lineCov">          6 :     fprintf (dump_file, &quot;Loop %i is do-while loop\n&quot;, loop-&gt;num);</span>
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            :   return true;
<span class="lineNum">     194 </span>            : }
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            : namespace {
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            : /* Common superclass for both header-copying phases.  */
<span class="lineNum">     199 </span>            : class ch_base : public gimple_opt_pass
<span class="lineNum">     200 </span>            : {
<span class="lineNum">     201 </span>            :   protected:
<span class="lineNum">     202 </span>            :     ch_base (pass_data data, gcc::context *ctxt)
<span class="lineNum">     203 </span><span class="lineCov">    1021872 :       : gimple_opt_pass (data, ctxt)</span>
<span class="lineNum">     204 </span>            :     {}
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            :   /* Copies headers of all loops in FUN for which process_loop_p is true.  */
<span class="lineNum">     207 </span>            :   unsigned int copy_headers (function *fun);
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span>            :   /* Return true to copy headers of LOOP or false to skip.  */
<span class="lineNum">     210 </span>            :   virtual bool process_loop_p (struct loop *loop) = 0;
<span class="lineNum">     211 </span>            : };
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span>            : const pass_data pass_data_ch =
<span class="lineNum">     214 </span>            : {
<span class="lineNum">     215 </span>            :   GIMPLE_PASS, /* type */
<span class="lineNum">     216 </span>            :   &quot;ch&quot;, /* name */
<span class="lineNum">     217 </span>            :   OPTGROUP_LOOP, /* optinfo_flags */
<span class="lineNum">     218 </span>            :   TV_TREE_CH, /* tv_id */
<span class="lineNum">     219 </span>            :   ( PROP_cfg | PROP_ssa ), /* properties_required */
<span class="lineNum">     220 </span>            :   0, /* properties_provided */
<span class="lineNum">     221 </span>            :   0, /* properties_destroyed */
<span class="lineNum">     222 </span>            :   0, /* todo_flags_start */
<span class="lineNum">     223 </span>            :   0, /* todo_flags_finish */
<span class="lineNum">     224 </span>            : };
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            : class pass_ch : public ch_base
<a name="227"><span class="lineNum">     227 </span>            : {</a>
<span class="lineNum">     228 </span>            : public:
<span class="lineNum">     229 </span><span class="lineCov">     340624 :   pass_ch (gcc::context *ctxt)</span>
<span class="lineNum">     230 </span><span class="lineCov">     340624 :     : ch_base (pass_data_ch, ctxt)</span>
<span class="lineNum">     231 </span><span class="lineCov">     340624 :   {}</span>
<a name="232"><span class="lineNum">     232 </span>            : </a>
<span class="lineNum">     233 </span>            :   /* opt_pass methods: */
<span class="lineNum">     234 </span><span class="lineCov">     621712 :   virtual bool gate (function *) { return flag_tree_ch != 0; }</span>
<span class="lineNum">     235 </span>            :   
<span class="lineNum">     236 </span>            :   /* Initialize and finalize loop structures, copying headers inbetween.  */
<a name="237"><span class="lineNum">     237 </span>            :   virtual unsigned int execute (function *);</a>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineCov">     170312 :   opt_pass * clone () { return new pass_ch (m_ctxt); }</span>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span>            : protected:
<span class="lineNum">     242 </span>            :   /* ch_base method: */
<span class="lineNum">     243 </span>            :   virtual bool process_loop_p (struct loop *loop);
<span class="lineNum">     244 </span>            : }; // class pass_ch
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            : const pass_data pass_data_ch_vect =
<span class="lineNum">     247 </span>            : {
<span class="lineNum">     248 </span>            :   GIMPLE_PASS, /* type */
<span class="lineNum">     249 </span>            :   &quot;ch_vect&quot;, /* name */
<span class="lineNum">     250 </span>            :   OPTGROUP_LOOP, /* optinfo_flags */
<span class="lineNum">     251 </span>            :   TV_TREE_CH, /* tv_id */
<span class="lineNum">     252 </span>            :   ( PROP_cfg | PROP_ssa ), /* properties_required */
<span class="lineNum">     253 </span>            :   0, /* properties_provided */
<span class="lineNum">     254 </span>            :   0, /* properties_destroyed */
<span class="lineNum">     255 </span>            :   0, /* todo_flags_start */
<span class="lineNum">     256 </span>            :   0, /* todo_flags_finish */
<span class="lineNum">     257 </span>            : };
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span>            : /* This is a more aggressive version of the same pass, designed to run just
<span class="lineNum">     260 </span>            :    before if-conversion and vectorization, to put more loops into the form
<span class="lineNum">     261 </span>            :    required for those phases.  */
<span class="lineNum">     262 </span>            : class pass_ch_vect : public ch_base
<a name="263"><span class="lineNum">     263 </span>            : {</a>
<span class="lineNum">     264 </span>            : public:
<span class="lineNum">     265 </span><span class="lineCov">     170312 :   pass_ch_vect (gcc::context *ctxt)</span>
<span class="lineNum">     266 </span><span class="lineCov">     170312 :     : ch_base (pass_data_ch_vect, ctxt)</span>
<span class="lineNum">     267 </span><span class="lineCov">     170312 :   {}</span>
<a name="268"><span class="lineNum">     268 </span>            : </a>
<span class="lineNum">     269 </span>            :   /* opt_pass methods: */
<span class="lineNum">     270 </span><span class="lineCov">     133094 :   virtual bool gate (function *fun)</span>
<span class="lineNum">     271 </span>            :   {
<span class="lineNum">     272 </span><span class="lineCov">     133094 :     return flag_tree_ch != 0</span>
<span class="lineNum">     273 </span><span class="lineCov">     133094 :            &amp;&amp; (flag_tree_loop_vectorize != 0 || fun-&gt;has_force_vectorize_loops);</span>
<span class="lineNum">     274 </span>            :   }
<span class="lineNum">     275 </span>            :   
<span class="lineNum">     276 </span>            :   /* Just copy headers, no initialization/finalization of loop structures.  */
<span class="lineNum">     277 </span>            :   virtual unsigned int execute (function *);
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span>            : protected:
<span class="lineNum">     280 </span>            :   /* ch_base method: */
<span class="lineNum">     281 </span>            :   virtual bool process_loop_p (struct loop *loop);
<span class="lineNum">     282 </span>            : }; // class pass_ch_vect
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span>            : /* For all loops, copy the condition at the end of the loop body in front
<span class="lineNum">     285 </span>            :    of the loop.  This is beneficial since it increases efficiency of
<span class="lineNum">     286 </span>            :    code motion optimizations.  It also saves one jump on entry to the loop.  */
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            : unsigned int
<span class="lineNum">     289 </span><span class="lineCov">     649208 : ch_base::copy_headers (function *fun)</span>
<span class="lineNum">     290 </span>            : {
<span class="lineNum">     291 </span><span class="lineCov">     649208 :   struct loop *loop;</span>
<span class="lineNum">     292 </span><span class="lineCov">     649208 :   basic_block header;</span>
<span class="lineNum">     293 </span><span class="lineCov">     649208 :   edge exit, entry;</span>
<span class="lineNum">     294 </span><span class="lineCov">     649208 :   basic_block *bbs, *copied_bbs;</span>
<span class="lineNum">     295 </span><span class="lineCov">     649208 :   unsigned n_bbs;</span>
<span class="lineNum">     296 </span><span class="lineCov">     649208 :   unsigned bbs_size;</span>
<span class="lineNum">     297 </span><span class="lineCov">     649208 :   bool changed = false;</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineCov">    1298416 :   if (number_of_loops (fun) &lt;= 1)</span>
<span class="lineNum">     300 </span>            :       return 0;
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineCov">     161371 :   bbs = XNEWVEC (basic_block, n_basic_blocks_for_fn (fun));</span>
<span class="lineNum">     303 </span><span class="lineCov">     161371 :   copied_bbs = XNEWVEC (basic_block, n_basic_blocks_for_fn (fun));</span>
<span class="lineNum">     304 </span><span class="lineCov">     161371 :   bbs_size = n_basic_blocks_for_fn (fun);</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineCov">     576601 :   FOR_EACH_LOOP (loop, 0)</span>
<span class="lineNum">     307 </span>            :     {
<span class="lineNum">     308 </span><span class="lineCov">     415230 :       int initial_limit = PARAM_VALUE (PARAM_MAX_LOOP_HEADER_INSNS);</span>
<span class="lineNum">     309 </span><span class="lineCov">     415230 :       int remaining_limit = initial_limit;</span>
<span class="lineNum">     310 </span><span class="lineCov">     415230 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     311 </span><span class="lineCov">          6 :         fprintf (dump_file,</span>
<span class="lineNum">     312 </span>            :                  &quot;Analyzing loop %i\n&quot;, loop-&gt;num);
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">     415230 :       header = loop-&gt;header;</span>
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span>            :       /* If the loop is already a do-while style one (either because it was
<span class="lineNum">     317 </span>            :          written as such, or because jump threading transformed it into one),
<span class="lineNum">     318 </span>            :          we might be in fact peeling the first iteration of the loop.  This
<span class="lineNum">     319 </span>            :          in general is not a good idea.  Also avoid touching infinite loops.  */
<span class="lineNum">     320 </span><span class="lineCov">     415230 :       if (!loop_has_exit_edges (loop)</span>
<span class="lineNum">     321 </span><span class="lineCov">     415230 :           || !process_loop_p (loop))</span>
<span class="lineNum">     322 </span><span class="lineCov">     248893 :         continue;</span>
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span>            :       /* Iterate the header copying up to limit; this takes care of the cases
<span class="lineNum">     325 </span>            :          like while (a &amp;&amp; b) {...}, where we want to have both of the conditions
<span class="lineNum">     326 </span>            :          copied.  TODO -- handle while (a || b) - like cases, by not requiring
<span class="lineNum">     327 </span>            :          the header to have just a single successor and copying up to
<span class="lineNum">     328 </span>            :          postdominator.  */
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            :       exit = NULL;
<span class="lineNum">     331 </span>            :       n_bbs = 0;
<span class="lineNum">     332 </span><span class="lineCov">     212013 :       while (should_duplicate_loop_header_p (header, loop, &amp;remaining_limit))</span>
<span class="lineNum">     333 </span>            :         {
<span class="lineNum">     334 </span>            :           /* Find a successor of header that is inside a loop; i.e. the new
<span class="lineNum">     335 </span>            :              header after the condition is copied.  */
<span class="lineNum">     336 </span><span class="lineCov">     166337 :           if (flow_bb_inside_loop_p (loop, EDGE_SUCC (header, 0)-&gt;dest))</span>
<span class="lineNum">     337 </span><span class="lineCov">      97153 :             exit = EDGE_SUCC (header, 0);</span>
<span class="lineNum">     338 </span>            :           else
<span class="lineNum">     339 </span><span class="lineCov">      69184 :             exit = EDGE_SUCC (header, 1);</span>
<span class="lineNum">     340 </span><span class="lineCov">     166337 :           bbs[n_bbs++] = header;</span>
<span class="lineNum">     341 </span><span class="lineCov">     166337 :           gcc_assert (bbs_size &gt; n_bbs);</span>
<span class="lineNum">     342 </span><span class="lineCov">     166337 :           header = exit-&gt;dest;</span>
<span class="lineNum">     343 </span>            :           /* Make sure to stop copying after we copied the first exit test.
<span class="lineNum">     344 </span>            :              Without further heuristics we do not want to rotate the loop
<span class="lineNum">     345 </span>            :              any further.  */
<span class="lineNum">     346 </span><span class="lineCov">     166337 :           if (loop_exits_from_bb_p (loop, exit-&gt;src))</span>
<span class="lineNum">     347 </span>            :             break;
<span class="lineNum">     348 </span>            :         }
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span><span class="lineCov">     212013 :       if (!exit)</span>
<span class="lineNum">     351 </span>            :         continue;
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">     166337 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     354 </span><span class="lineCov">         12 :         fprintf (dump_file,</span>
<span class="lineNum">     355 </span>            :                  &quot;Duplicating header of the loop %d up to edge %d-&gt;%d,&quot;
<span class="lineNum">     356 </span>            :                  &quot; %i insns.\n&quot;,
<span class="lineNum">     357 </span><span class="lineCov">          4 :                  loop-&gt;num, exit-&gt;src-&gt;index, exit-&gt;dest-&gt;index,</span>
<span class="lineNum">     358 </span>            :                  initial_limit - remaining_limit);
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :       /* Ensure that the header will have just the latch as a predecessor
<span class="lineNum">     361 </span>            :          inside the loop.  */
<span class="lineNum">     362 </span><span class="lineCov">     166337 :       if (!single_pred_p (exit-&gt;dest))</span>
<span class="lineNum">     363 </span><span class="lineCov">         10 :         exit = single_pred_edge (split_edge (exit));</span>
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineCov">     166337 :       entry = loop_preheader_edge (loop);</span>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineCov">     166337 :       propagate_threaded_block_debug_into (exit-&gt;dest, entry-&gt;dest);</span>
<span class="lineNum">     368 </span><span class="lineCov">     166337 :       if (!gimple_duplicate_sese_region (entry, exit, bbs, n_bbs, copied_bbs,</span>
<span class="lineNum">     369 </span>            :                                          true))
<span class="lineNum">     370 </span>            :         {
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :           fprintf (dump_file, &quot;Duplication failed.\n&quot;);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     373 </span>            :         }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span>            :       /* If the loop has the form &quot;for (i = j; i &lt; j + 10; i++)&quot; then
<span class="lineNum">     376 </span>            :          this copying can introduce a case where we rely on undefined
<span class="lineNum">     377 </span>            :          signed overflow to eliminate the preheader condition, because
<span class="lineNum">     378 </span>            :          we assume that &quot;j &lt; j + 10&quot; is true.  We don't want to warn
<span class="lineNum">     379 </span>            :          about that case for -Wstrict-overflow, because in general we
<span class="lineNum">     380 </span>            :          don't warn about overflow involving loops.  Prevent the
<span class="lineNum">     381 </span>            :          warning by setting the no_warning flag in the condition.  */
<span class="lineNum">     382 </span><span class="lineCov">     166337 :       if (warn_strict_overflow &gt; 0)</span>
<span class="lineNum">     383 </span>            :         {
<span class="lineNum">     384 </span>            :           unsigned int i;
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">      63262 :           for (i = 0; i &lt; n_bbs; ++i)</span>
<span class="lineNum">     387 </span>            :             {
<span class="lineNum">     388 </span><span class="lineCov">      31631 :               gimple_stmt_iterator bsi;</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineCov">      63262 :               for (bsi = gsi_start_bb (copied_bbs[i]);</span>
<span class="lineNum">     391 </span><span class="lineCov">     283264 :                    !gsi_end_p (bsi);</span>
<span class="lineNum">     392 </span><span class="lineCov">     110001 :                    gsi_next (&amp;bsi))</span>
<span class="lineNum">     393 </span>            :                 {
<span class="lineNum">     394 </span><span class="lineCov">     110001 :                   gimple *stmt = gsi_stmt (bsi);</span>
<span class="lineNum">     395 </span><span class="lineCov">     220002 :                   if (gimple_code (stmt) == GIMPLE_COND)</span>
<span class="lineNum">     396 </span><span class="lineCov">      31631 :                     gimple_set_no_warning (stmt, true);</span>
<span class="lineNum">     397 </span><span class="lineCov">     156740 :                   else if (is_gimple_assign (stmt))</span>
<span class="lineNum">     398 </span>            :                     {
<span class="lineNum">     399 </span><span class="lineCov">      11419 :                       enum tree_code rhs_code = gimple_assign_rhs_code (stmt);</span>
<span class="lineNum">     400 </span><span class="lineCov">      11419 :                       if (TREE_CODE_CLASS (rhs_code) == tcc_comparison)</span>
<span class="lineNum">     401 </span><span class="lineCov">        549 :                         gimple_set_no_warning (stmt, true);</span>
<span class="lineNum">     402 </span>            :                     }
<span class="lineNum">     403 </span>            :                 }
<span class="lineNum">     404 </span>            :             }
<span class="lineNum">     405 </span>            :         }
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            :       /* Ensure that the latch and the preheader is simple (we know that they
<span class="lineNum">     408 </span>            :          are not now, since there was the loop exit condition.  */
<span class="lineNum">     409 </span><span class="lineCov">     166337 :       split_edge (loop_preheader_edge (loop));</span>
<span class="lineNum">     410 </span><span class="lineCov">     166337 :       split_edge (loop_latch_edge (loop));</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">     166337 :       if (dump_file &amp;&amp; (dump_flags &amp; TDF_DETAILS))</span>
<span class="lineNum">     413 </span>            :         {
<span class="lineNum">     414 </span><span class="lineCov">          4 :           if (do_while_loop_p (loop))</span>
<span class="lineNum">     415 </span><span class="lineCov">          4 :             fprintf (dump_file, &quot;Loop %d is now do-while loop.\n&quot;, loop-&gt;num);</span>
<span class="lineNum">     416 </span>            :           else
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :             fprintf (dump_file, &quot;Loop %d is still not do-while loop.\n&quot;,</span>
<span class="lineNum">     418 </span>            :                      loop-&gt;num);
<span class="lineNum">     419 </span>            :         }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">     166337 :       changed = true;</span>
<span class="lineNum">     422 </span>            :     }
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">     161371 :   if (changed)</span>
<span class="lineNum">     425 </span><span class="lineCov">      69018 :     update_ssa (TODO_update_ssa);</span>
<span class="lineNum">     426 </span><span class="lineCov">     161371 :   free (bbs);</span>
<span class="lineNum">     427 </span><span class="lineCov">     161371 :   free (copied_bbs);</span>
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineCov">     161371 :   return changed ? TODO_cleanup_cfg : 0;</span>
<span class="lineNum">     430 </span>            : }
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span>            : /* Initialize the loop structures we need, and finalize after.  */
<a name="433"><span class="lineNum">     433 </span>            : </a>
<span class="lineNum">     434 </span>            : unsigned int
<span class="lineNum">     435 </span><span class="lineCov">     621660 : pass_ch::execute (function *fun)</span>
<span class="lineNum">     436 </span>            : {
<span class="lineNum">     437 </span><span class="lineCov">     621660 :   loop_optimizer_init (LOOPS_HAVE_PREHEADERS</span>
<span class="lineNum">     438 </span>            :                        | LOOPS_HAVE_SIMPLE_LATCHES
<span class="lineNum">     439 </span>            :                        | LOOPS_HAVE_RECORDED_EXITS);
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">     621660 :   unsigned int res = copy_headers (fun);</span>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineCov">     621660 :   loop_optimizer_finalize ();</span>
<span class="lineNum">     444 </span><span class="lineCov">     621660 :   return res;</span>
<span class="lineNum">     445 </span>            : }
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span>            : /* Assume an earlier phase has already initialized all the loop structures that
<span class="lineNum">     448 </span>            :    we need here (and perhaps others too), and that these will be finalized by
<span class="lineNum">     449 </span>            :    a later phase.  */
<a name="450"><span class="lineNum">     450 </span>            :    </a>
<span class="lineNum">     451 </span>            : unsigned int
<span class="lineNum">     452 </span><span class="lineCov">      27548 : pass_ch_vect::execute (function *fun)</span>
<span class="lineNum">     453 </span>            : {
<span class="lineNum">     454 </span><span class="lineCov">      27548 :   return copy_headers (fun);</span>
<span class="lineNum">     455 </span>            : }
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span>            : /* Apply header copying according to a very simple test of do-while shape.  */
<a name="458"><span class="lineNum">     458 </span>            : </a>
<span class="lineNum">     459 </span>            : bool
<span class="lineNum">     460 </span><span class="lineCov">     341206 : pass_ch::process_loop_p (struct loop *loop)</span>
<span class="lineNum">     461 </span>            : {
<span class="lineNum">     462 </span><span class="lineCov">     341206 :   return !do_while_loop_p (loop);</span>
<span class="lineNum">     463 </span>            : }
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            : /* Apply header-copying to loops where we might enable vectorization.  */
<a name="466"><span class="lineNum">     466 </span>            : </a>
<span class="lineNum">     467 </span>            : bool
<span class="lineNum">     468 </span><span class="lineCov">      70386 : pass_ch_vect::process_loop_p (struct loop *loop)</span>
<span class="lineNum">     469 </span>            : {
<span class="lineNum">     470 </span><span class="lineCov">      70386 :   if (!flag_tree_loop_vectorize &amp;&amp; !loop-&gt;force_vectorize)</span>
<span class="lineNum">     471 </span>            :     return false;
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineCov">      68045 :   if (loop-&gt;dont_vectorize)</span>
<span class="lineNum">     474 </span>            :     return false;
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">      68040 :   if (!do_while_loop_p (loop))</span>
<span class="lineNum">     477 </span>            :     return true;
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :  /* The vectorizer won't handle anything with multiple exits, so skip.  */
<span class="lineNum">     480 </span><span class="lineCov">      63290 :   edge exit = single_exit (loop);</span>
<span class="lineNum">     481 </span><span class="lineCov">      63290 :   if (!exit)</span>
<span class="lineNum">     482 </span>            :     return false;
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span>            :   /* Copy headers iff there looks to be code in the loop after the exit block,
<span class="lineNum">     485 </span>            :      i.e. the exit block has an edge to another block (besides the latch,
<span class="lineNum">     486 </span>            :      which should be empty).  */
<span class="lineNum">     487 </span><span class="lineCov">      48618 :   edge_iterator ei;</span>
<span class="lineNum">     488 </span><span class="lineCov">      48618 :   edge e;</span>
<span class="lineNum">     489 </span><span class="lineCov">     194472 :   FOR_EACH_EDGE (e, ei, exit-&gt;src-&gt;succs)</span>
<span class="lineNum">     490 </span><span class="lineCov">      97236 :     if (!loop_exit_edge_p (loop, e)</span>
<span class="lineNum">     491 </span><span class="lineCov">      48618 :         &amp;&amp; e-&gt;dest != loop-&gt;header</span>
<span class="lineNum">     492 </span><span class="lineCov">     145854 :         &amp;&amp; e-&gt;dest != loop-&gt;latch)</span>
<span class="lineNum">     493 </span>            :       return true;
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            :   return false;
<span class="lineNum">     496 </span>            : }
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span>            : } // anon namespace
<a name="499"><span class="lineNum">     499 </span>            : </a>
<span class="lineNum">     500 </span>            : gimple_opt_pass *
<span class="lineNum">     501 </span><span class="lineCov">     170312 : make_pass_ch_vect (gcc::context *ctxt)</span>
<span class="lineNum">     502 </span>            : {
<span class="lineNum">     503 </span><span class="lineCov">     170312 :   return new pass_ch_vect (ctxt);</span>
<span class="lineNum">     504 </span>            : }
<a name="505"><span class="lineNum">     505 </span>            : </a>
<span class="lineNum">     506 </span>            : gimple_opt_pass *
<span class="lineNum">     507 </span><span class="lineCov">     170312 : make_pass_ch (gcc::context *ctxt)</span>
<span class="lineNum">     508 </span>            : {
<span class="lineNum">     509 </span><span class="lineCov">     170312 :   return new pass_ch (ctxt);</span>
<span class="lineNum">     510 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.0</a></td></tr>
  </table>
  <br>
<h3>LCOV profile is generated on x86_64 machine using following configure options: configure --disable-bootstrap --enable-coverage=opt --enable-languages=c,c++,fortran,go,jit,lto --enable-host-shared. GCC test suite is run with the built compiler.</h3></body></html>
